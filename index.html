<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>jQuery / auto load</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>

        <!-- class"cotice"の文字の大きさ・枠線の太さ、色・padding -->
        <style>
        p.notice {
            font-size: 0.8em;
            border: 1px solid #CCCCCC;
            padding: 10px;
        }
        </style>
        <script>
        jQuery(function($){
        	/*terget内をオートロードしますよ～*/
            var autoLoader = new AutoLoader('#target');
        });
        (function($){
            function AutoLoader(){
            	/*今使ってる引数の中身を適用しますよ～*/
                this.init.apply(this, arguments);
            }
            AutoLoader.prototype = {
            		/*しきい値*/
                threshold: 10,
                auto: true,
                page: 1,
                loading: false,
                init: function(selector){
                    this.window = $(window);
                    this.target = $(selector);
                    while (this.check()){
                        this.load();
                    }
                    this.autoLoad();
                },
                check: function(){
                    if (!this.auto){
                        return;
                    }
                    /*コンテンツの下端の位置座標を求める*/
                    var content = this.target.offset().top + this.target.height();
                    /*どの位置まウィンドウに表示されるか求める*/
                    var display = this.window.scrollTop() + this.window.height();
                    /*コンテンツが1万px以上ならオートを終します～*/
                    if (content > 10000){
                        this.auto = false;
                    }
                    /*もし、cont-disの合計がしきい値以下だった場合*/
                    if (content - display < this.threshold){
                        return true;
                    } else {
                        return false;
                    }
                },
                load: function(){
                	this.target.append($('<p></p>')./*ページを作成しますよ～*/
                	append('page' + this.page)./*"page"という文字を出力しますよ*/
                	css('height', 500)./*高さは500ですよ～*/
                	addClass('notice')./*追加したいclass名*/
                	fadeIn(3000));/*3秒かけて現れますよ～*/
                    this.page++;/*"page"の後の数字を1から順に出力しますよ～*/
                },

                autoLoad: function(){
                    var self = this;
                    self.window.scroll(function(){
                        if (self.check()){
                            if (this.loading){
                                return;
                            }
                            this.loading = true;
                            self.load();
                            // 仮に setTimeout で代用。AJAXなどでロードに時間がかかったときは onComplete などで処理します
                            setTimeout(function(){
                                this.loading = false;
                            }, 100);
                        }
                    });
                }
            };
            window.AutoLoader = AutoLoader;
        })(jQuery);
        </script>
    </head>
    <body>
        <h1>jQuery / Auto Load</h1>
        <p><a href="http://yurubu.org/jquery-autoload/513">スクロールで次のページを自動読み込み</a>のサンブルです</p>
        <p class="notice">
        ウィンドウをスクロールした際に、表示コンテンツが残り10px以内になると自動で続き(ダミー)を読み込みます。<br />
        また、初回のみウィンドウの下端に達するまで連続で読み込んでます。<br />
        わかりやすいように読み込み時のフェードインを3秒にしています。<br />
        対象となるコンテンツ部分の高さが10000pxを超えると読み込みをやめます。(※実際は最後のページを読み込んだ時とか)
        </p>
        <p class="notice">
        2011.04.21追記<br />
        オートロードするデータが同時に複数読み込まれないように排他制御入れました。<br />
        AJAXでデータ取ってくる時とか困るので。
        </p>
        <div id="target"></div>
        <a href="index.html">戻る</a>
</body>
</html>